<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel · Üsküdar Sahne</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#111521; --card:#171923; --muted:#8b8fa3; --text:#e5e7f0;
      --accent:#60a5fa; --danger:#ef4444; --ok:#22c55e; --stroke:#232633; --hover:#1b243b;
      --sidebar:#0c1018;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{ margin:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }

    header{
      position:sticky; top:0; z-index:20;
      background:#0b0d12; border-bottom:1px solid var(--stroke);
      height:56px; display:flex; align-items:center; justify-content:center;
      padding:0 max(16px, env(safe-area-inset-right)) 0 max(16px, env(safe-area-inset-left));
    }
    header h1{ margin:0; font-size:16px; letter-spacing:.2px; text-align:center; }
    .hdr-actions{ position:absolute; right:12px; top:0; height:56px; display:flex; align-items:center; gap:8px; color:var(--muted); font-size:12px; }

    .btn{ display:inline-flex; align-items:center; gap:8px; padding:9px 12px; border-radius:10px; border:1px solid transparent; background:var(--hover); color:#fff; cursor:pointer; font-weight:600; }
    .btn:hover{ filter:brightness(1.05); }
    .btn.primary{ background: linear-gradient(180deg, #2563eb, #1d4ed8); }
    .btn.ghost{ background:transparent; border-color:var(--stroke); }
    .btn.danger{ background:#2a0f14; border-color:#5e1b27; color:#ffb4be; }
    .btn[disabled]{ opacity:.5; cursor:not-allowed; }
    .mini{ font-size:12px; padding:7px 10px; }

    #btnMenu{ position:absolute; left:12px; top:8px; height:40px; width:40px; display:none; align-items:center; justify-content:center; border-radius:10px; border:1px solid var(--stroke); background:transparent; color:#d6daf0; cursor:pointer; }
    #btnMenu:hover{ background:#12192a; }

    .wrap{ display:flex; min-height:calc(100vh - 56px); }
    .sidebar{
      position:sticky; top:56px; height:calc(100vh - 56px);
      width:230px; background:var(--sidebar); border-right:1px solid var(--stroke);
      padding:14px 10px; display:flex; flex-direction:column; gap:10px;
      transition: transform .25s ease; z-index:21;
    }
    .brand{ color:#aab4d6; font-weight:700; font-size:13px; letter-spacing:.6px; padding:8px 10px; opacity:.8; }
    .nav-item{ width:100%; text-align:left; background:transparent; border:1px solid var(--stroke); color:#d6daf0; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:600; }
    .nav-item:hover{ background:#12192a; }
    .nav-item.active{ background:#16213a; border-color:#2a3553; color:#a6c4ff; }

    .main{ flex:1; padding:20px; min-width:0; }

    .card{ background:var(--card); border:1px solid var(--stroke); border-radius:14px; padding:16px; }
    .toolrow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .toolrow .grow{ flex:1; min-width:220px; }
    input[type="search"], input[type="text"], input[type="number"], textarea, select{
      width:100%; padding:10px 12px; background:#0f1320; color:var(--text); border:1px solid #2a2f45; border-radius:10px; outline:none;
    }
    .note{ font-size:12px; color:#aab; margin-top:8px; }
    .titlebar{ font-size:15px; font-weight:700; margin-bottom:8px; }

    .grid-cards{ display:grid; gap:12px; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); margin-top:12px; }
    .itm{ background:#101321; border:1px solid var(--stroke); border-radius:12px; cursor:pointer; overflow:hidden; display:flex; flex-direction:column; }
    .itm:hover{ border-color:#2a3553; background:#12182a; }
    .thumb{ width:100%; aspect-ratio: 16/10; object-fit:cover; background:#0c0f1b; border-bottom:1px solid var(--stroke); }
    .itm-body{ padding:10px; display:flex; flex-direction:column; gap:6px; }
    .muted{ color:var(--muted); font-size:12px; }

    .centered{ max-width:520px; margin:20px auto; }

    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:50; }
    .modal.show{ display:flex; }
    .backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.55); }
    .modal .sheet{ position:relative; width:min(680px, 92vw); background:var(--panel); border:1px solid var(--stroke); border-radius:14px; padding:16px; z-index:1; }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .row + .row{ margin-top:10px; }
    label{ display:block; font-size:12px; color:var(--muted); margin:10px 0 6px; }

    .sb-backdrop{ display:none; }
    .hide{ display:none !important; }

    @media (max-width: 1024px){ .grid-cards{ grid-template-columns: repeat(auto-fill, minmax(190px, 1fr)); } }
    @media (max-width: 920px){
      #btnMenu{ display:inline-flex; }
      header h1{ max-width:60%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
      .wrap{ display:block; } .main{ padding:16px; }
      .sidebar{ position:fixed; left:0; top:56px; height:calc(100svh - 56px); width:min(86vw, 300px); transform:translateX(-100%); }
      .sidebar.show{ transform:translateX(0); }
      .sb-backdrop{ display:none; position:fixed; inset:56px 0 0 0; background:rgba(0,0,0,.5); z-index:19; }
      body.sidebar-open .sb-backdrop{ display:block; }
      .row{ grid-template-columns: 1fr; } .toolrow .grow{ min-width:140px; } .grid-cards{ grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
    }
  </style>
</head>
<body>
  <header>
    <button id="btnMenu" aria-label="Menü" title="Menü">☰</button>
    <h1>Admin Panel · Üsküdar Sahne</h1>
    <div class="hdr-actions">
      <span id="status">Bağlı değil</span>
      <button class="btn ghost mini" id="btnLogout" hidden>Çıkış</button>
    </div>
  </header>

  <div class="wrap">
    <div class="sb-backdrop" id="sbBackdrop"></div>

    <aside class="sidebar" id="sidebar" hidden>
      <div class="brand">Yönetim</div>
      <button class="nav-item active" data-tab="cats">Kategoriler</button>
      <button class="nav-item" data-tab="prods">Ürünler</button>
      <button class="nav-item" data-tab="events">Etkinlikler</button>
    </aside>

    <main class="main">
      <!-- LOGIN -->
      <section class="card centered" id="loginCard">
        <h2 style="margin:0 0 12px;">Giriş</h2>
        <div class="row">
          <div>
            <label for="username">Kullanıcı adı</label>
            <input id="username" autocomplete="username" placeholder="admin" />
          </div>
          <div>
            <label for="password">Şifre</label>
            <input id="password" type="password" autocomplete="current-password" placeholder="••••••••" />
          </div>
        </div>
        <div class="toolrow" style="margin-top:12px; justify-content:flex-end;">
          <button class="btn primary" id="btnLogin">Giriş yap</button>
        </div>
        <div id="loginMsg" class="note"></div>
      </section>

      <!-- APP PANELS -->
      <section id="app" class="hide">
        <div class="card">
          <div id="pageTitle" class="titlebar">Kategoriler</div>
          <div class="toolrow">
            <input class="grow" type="search" id="searchInput" placeholder="İsme göre ara…" />
            <button class="btn primary" id="btnAdd">+ Ekle</button>
          </div>
          <div id="infoMsg" class="note"></div>
          <div class="grid-cards" id="grid"></div>
        </div>
      </section>
    </main>
  </div>

  <!-- MODAL -->
  <div class="modal" id="modal">
    <div class="backdrop" data-close></div>
    <div class="sheet">
      <h3 id="modalTitle" style="margin:0 0 10px; font-size:15px;">Yeni Kayıt</h3>
      <form id="modalForm">
        <input type="hidden" id="formId" />
        <div class="row">
          <div>
            <label for="formName">İsim</label>
            <input id="formName" required />
          </div>
          <div id="slotType" class="hide">
            <label for="formKind">Tür</label>
            <select id="formKind">
              <option value="food">Yemek</option>
              <option value="drink">İçecek</option>
            </select>
          </div>
        </div>

        <div id="slotDesc" class="hide">
          <label for="formDesc">Açıklama (opsiyonel)</label>
          <textarea id="formDesc" rows="3"></textarea>
        </div>

        <div id="slotPrice" class="row hide">
          <div>
            <label for="formPrice">Fiyat (₺)</label>
            <input id="formPrice" type="number" step="0.01" min="0" />
          </div>
          <div>
            <label for="formCategory">Kategori</label>
            <select id="formCategory"></select>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="formImage">Görsel</label>
            <input id="formImage" type="file" accept="image/*" />
          </div>
          <div>
            <label>Önizleme</label>
            <img id="formPreview" class="thumb" alt="" />
          </div>
        </div>

        <div class="toolrow" style="margin-top:12px; justify-content:flex-end;">
          <button class="btn ghost" type="button" data-close>Kapat</button>
          <button class="btn primary" id="btnSave" type="submit" disabled>Kaydet</button>
        </div>
        <div id="formMsg" class="note"></div>
      </form>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const API_BASE = "http://localhost:4000"; // aynı origin. Gerekirse: 
    const EP = {
      login:      API_BASE + "/api/auth/login",
      logout:     API_BASE + "/api/auth/logout",
      me:         API_BASE + "/api/auth/me",

      // Admin (lazy fetch)
      cats:       API_BASE + "/api/admin/categories",
      prods:      API_BASE + "/api/admin/products",
      events:     API_BASE + "/api/admin/events",

      // CRUD
      upCat:  id => API_BASE + `/api/admin/upload/categories/${id}`,
      upProd: id => API_BASE + `/api/admin/upload/products/${id}`,
      upEvent:id => API_BASE + `/api/admin/upload/events/${id}`,

      postCat:    API_BASE + "/api/admin/categories",
      postProd:   API_BASE + "/api/admin/products",
      postEvent:  API_BASE + "/api/admin/events",
      putCat: id => API_BASE + `/api/admin/categories/${id}`,
      putProd:id => API_BASE + `/api/admin/products/${id}`,
      putEvent:id => API_BASE + `/api/admin/events/${id}`,
      delCat: id => API_BASE + `/api/admin/categories/${id}`,
      delProd:id => API_BASE + `/api/admin/products/${id}`,
      delEvent:id => API_BASE + `/api/admin/events/${id}`,
    };

    // ===== STATE =====
    const $ = s => document.querySelector(s);
    let TAB = "cats"; // cats | prods | events
    let DATA = { cats:null, prods:null, events:null }; // her sekmede fetch edilecek
    let FILTER = "";
    let ORIG = null; // modal'da karşılaştırma için orijinal obje
    let FILE_CHANGED = false;

    // ===== HELPERS =====
    function setStatus(t){ $('#status').textContent = t; }
    function show(el){ el.classList.remove('hide'); }
    function hide(el){ el.classList.add('hide'); }
    function esc(str){ return (str||"").toString(); }
    const fmt = n => new Intl.NumberFormat('tr-TR',{style:'currency',currency:'TRY'}).format(Number(n)||0);

    async function http(method, url, body, json=true){
      const opt = { method, credentials:'include', headers:{} };
      if(body){
        if(json){ opt.headers['Content-Type']='application/json'; opt.body=JSON.stringify(body); }
        else { opt.body = body; }
      }
      const res = await fetch(url, opt);
      if(res.status===401) throw new Error('401');
      if(!res.ok){
        let msg = '';
        try{ const j = await res.json(); msg = j.message || j.error || ''; }catch(_){}
        throw new Error(msg || `Hata: ${res.status}`);
      }
      const ct = res.headers.get('content-type')||'';
      return ct.includes('application/json') ? res.json() : res.text();
    }

    // ===== AUTH =====
    $('#btnLogin').addEventListener('click', async ()=>{
      const username = $('#username').value.trim();
      const password = $('#password').value;
      $('#loginMsg').textContent = '';
      try{
        await http('POST', EP.login, { username, password });
        onLoggedIn(username);
      }catch(err){
        if(err.message==='401'){ $('#loginMsg').textContent='Hatalı kullanıcı adı/şifre'; }
        else $('#loginMsg').textContent = err.message||'Giriş başarısız';
        setStatus('Bağlı değil');
      }
    });

    function onLoggedIn(name){
      $('#btnLogout').hidden = false;
      $('#sidebar').hidden = false;
      hide($('#loginCard')); show($('#app'));
      setStatus(`Giriş yapıldı: ${name||''}`);
      loadCurrent();
    }

    $('#btnLogout').addEventListener('click', async ()=>{
      try{ await http('POST', EP.logout); }catch(_){}
      location.reload();
    });

    // Sayfa açılışında session varsa loginli kalsın
    (async function boot(){
      try{
        const me = await http('GET', EP.me);
        if(me.loggedIn){
          onLoggedIn(me.user?.username || 'admin');
        }
      }catch(_){}
    })();

    // ===== SIDEBAR =====
    const closeSidebar = ()=>{
      document.body.classList.remove('sidebar-open');
      $('#sidebar').classList.remove('show');
    };
    $('#btnMenu').addEventListener('click', ()=>{
      document.body.classList.toggle('sidebar-open');
      $('#sidebar').classList.toggle('show');
    });
    $('#sbBackdrop').addEventListener('click', closeSidebar);
    window.addEventListener('resize', ()=>{ if(window.innerWidth > 920){ closeSidebar(); } });

    // Sekme değişimi
    document.querySelectorAll('.nav-item').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        TAB = btn.dataset.tab;
        $('#pageTitle').textContent = TAB==='cats'?'Kategoriler':TAB==='prods'?'Ürünler':'Etkinlikler';
        $('#searchInput').value = '';
        FILTER = '';
        closeSidebar();
        await loadCurrent(true);
      });
    });

    // ===== SEARCH =====
    $('#searchInput').addEventListener('input', (e)=>{ FILTER = e.target.value.toLowerCase().trim(); renderGrid(); });

    // ===== DATA LOAD (lazy) =====
    async function loadCurrent(force=false){
      const t = TAB;
      $('#infoMsg').textContent = '';
      try{
        if(force || DATA[t] == null){
          if(t==='cats') DATA.cats = await http('GET', EP.cats);
          else if(t==='prods') DATA.prods = await http('GET', EP.prods);
          else DATA.events = await http('GET', EP.events);
        }
        renderGrid();
      }catch(err){
        $('#infoMsg').textContent = 'Veri yüklenemedi: ' + err.message;
      }
    }

    // ===== GRID RENDER =====
    function filtered(list){
      if(!FILTER) return list||[];
      const f = FILTER;
      return (list||[]).filter(x => (x.name||'').toLowerCase().includes(f));
    }

    function renderGrid(){
      const grid = $('#grid'); grid.innerHTML = '';
      const listRaw = TAB==='cats' ? DATA.cats : TAB==='prods' ? DATA.prods : DATA.events;
      const list = filtered(listRaw||[]);

      if(list.length===0){ grid.innerHTML = `<div class="note">Kayıt bulunamadı.</div>`; return; }

      list.forEach(obj=>{
        const img = obj.images?.w640 || obj.imageUrl || '';
        const title = esc(obj.name||'');
        let sub = '';
        if(TAB==='cats'){
          sub = (obj.kind==='drink'?'İçecek':'Yemek') + (obj.updatedAt? ` · ${new Date(obj.updatedAt).toLocaleDateString('tr-TR')}` : '');
        } else if(TAB==='prods'){
          const price = obj.price && (obj.price.$numberDecimal || obj.price);
          sub = `${fmt(price)}${obj.categoryName? ' · '+obj.categoryName:''}`;
        } else {
          sub = (obj.updatedAt? new Date(obj.updatedAt).toLocaleDateString('tr-TR') : '');
        }

        const card = document.createElement('div');
        card.className='itm';
        card.innerHTML = `
          <img class="thumb" src="${img}" alt="">
          <div class="itm-body">
            <div style="font-weight:700; font-size:14px;">${title}</div>
            <div class="muted">${esc(sub)}</div>
          </div>`;
        card.addEventListener('click', ()=> openModalForEdit(obj));
        grid.append(card);
      });
    }

    // ===== MODAL (EKLE/DÜZENLE) =====
    $('#btnAdd').addEventListener('click', ()=> openModalForCreate());

    function resetModal(){
      ORIG = null; FILE_CHANGED = false;
      $('#formId').value = '';
      $('#formName').value = '';
      $('#formDesc').value = '';
      $('#formPrice').value = '';
      $('#formCategory').innerHTML = '';
      $('#formKind').value = 'food';
      $('#formImage').value = '';
      $('#formPreview').src = '';
      $('#formMsg').textContent = '';
      setSaveEnabled(false);
    }
    function setSaveEnabled(on){ $('#btnSave').disabled = !on; }

    function openModalForCreate(){
      resetModal();
      $('#modalTitle').textContent = TAB==='cats' ? 'Yeni Kategori' : TAB==='prods' ? 'Yeni Ürün' : 'Yeni Etkinlik';

      // alan görünürlükleri
      $('#slotType').classList.toggle('hide', TAB!=='cats');
      $('#slotDesc').classList.toggle('hide', TAB==='cats');
      $('#slotPrice').classList.toggle('hide', TAB!=='prods');

      if(TAB==='prods'){
        (DATA.cats||[]).forEach(c=>{
          const o = document.createElement('option');
          o.value = c._id; o.textContent = c.name; $('#formCategory').append(o);
        });
      }
      $('#modal').classList.add('show');
      updateSaveState(); // create modunda valid değil ise disable
    }

    function openModalForEdit(obj){
      resetModal();
      ORIG = JSON.parse(JSON.stringify(obj)); // deep copy
      $('#modalTitle').textContent = TAB==='cats' ? 'Kategoriyi Düzenle' : TAB==='prods' ? 'Ürünü Düzenle' : 'Etkinliği Düzenle';
      $('#formId').value = obj._id;
      $('#formName').value = obj.name || '';
      $('#formDesc').value = obj.description || '';
      const price = obj.price && (obj.price.$numberDecimal || obj.price);
      $('#formPrice').value = price || '';
      $('#formPreview').src = (obj.images?.w640 || obj.imageUrl || '');

      $('#slotType').classList.toggle('hide', TAB!=='cats');
      $('#slotDesc').classList.toggle('hide', TAB==='cats');
      $('#slotPrice').classList.toggle('hide', TAB!=='prods');

      if(TAB==='cats'){ $('#formKind').value = obj.kind || 'food'; }
      if(TAB==='prods'){
        $('#formCategory').innerHTML = '';
        (DATA.cats||[]).forEach(c=>{
          const o = document.createElement('option'); o.value=c._id; o.textContent=c.name;
          if(String(obj.categoryId)===String(c._id)) o.selected = true;
          $('#formCategory').append(o);
        });
      }
      $('#modal').classList.add('show');
      updateSaveState(); // başlangıçta değişiklik yok => disable
    }

    document.querySelectorAll('[data-close]').forEach(n=> n.addEventListener('click', ()=> $('#modal').classList.remove('show')));

    // file preview + dirty
    $('#formImage').addEventListener('change', ()=>{
      const f = $('#formImage').files?.[0];
      FILE_CHANGED = !!f;
      if(!f){ $('#formPreview').src=''; updateSaveState(); return; }
      const r = new FileReader(); r.onload = ()=> { $('#formPreview').src = r.result; updateSaveState(); }; r.readAsDataURL(f);
    });

    // değişiklik takibi
    ['formName','formDesc','formPrice','formCategory','formKind'].forEach(id=>{
      const node = document.getElementById(id);
      node.addEventListener('input', updateSaveState);
      node.addEventListener('change', updateSaveState);
    });

    function isValidForm(){
      const name = $('#formName').value.trim();
      if(!name) return false;
      if(TAB==='cats'){
        return !!$('#formKind').value;
      } else if(TAB==='prods'){
        const price = parseFloat($('#formPrice').value);
        const cat = $('#formCategory').value;
        return !!cat && !Number.isNaN(price);
      } else {
        return true; // events: sadece name zorunlu
      }
    }

    function isDirty(){
      if(!ORIG) return ( // create
        isValidForm() // valid ve en az bir alan dolu
      );
      // edit modunda alan kıyasla
      if(FILE_CHANGED) return true;
      const name = $('#formName').value.trim();
      if(name !== (ORIG.name||'')) return true;
      if(TAB==='cats'){
        if($('#formKind').value !== (ORIG.kind||'food')) return true;
      } else if(TAB==='prods'){
        const priceNow = $('#formPrice').value;
        const priceOrig = ORIG.price && (ORIG.price.$numberDecimal || ORIG.price) || '';
        if(String(priceNow) !== String(priceOrig)) return true;
        if($('#formCategory').value !== String(ORIG.categoryId||'')) return true;
        if(($('#formDesc').value||'') !== (ORIG.description||'')) return true;
      } else {
        if(($('#formDesc').value||'') !== (ORIG.description||'')) return true;
      }
      return false;
    }

    function updateSaveState(){ setSaveEnabled(isValidForm() && isDirty()); }

    // ===== SUBMIT =====
    $('#modalForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const id = $('#formId').value.trim();
      const name = $('#formName').value.trim();
      const description = $('#formDesc').value.trim();
      const file = $('#formImage').files?.[0] || null;
      const msg = $('#formMsg');

      try{
        if(TAB==='cats'){
          const kind = $('#formKind').value;
          const payload = { name, kind };
          const res = id ? await http('PUT', EP.putCat(id), payload)
                         : await http('POST', EP.postCat, payload);
          const _id = res._id || id;
          if(file){ const fd = new FormData(); fd.append('file', file); await http('POST', EP.upCat(_id), fd, false); }
        }
        else if(TAB==='prods'){
          const price = parseFloat($('#formPrice').value);
          const categoryId = $('#formCategory').value;
          const payload = { name, description, price, categoryId };
          const res = id ? await http('PUT', EP.putProd(id), payload)
                         : await http('POST', EP.postProd, payload);
          const _id = res._id || id;
          if(file){ const fd = new FormData(); fd.append('file', file); await http('POST', EP.upProd(_id), fd, false); }
        }
        else {
          const payload = { name, description };
          const res = id ? await http('PUT', EP.putEvent(id), payload)
                         : await http('POST', EP.postEvent, payload);
          const _id = res._id || id;
          if(file){ const fd = new FormData(); fd.append('file', file); await http('POST', EP.upEvent(_id), fd, false); }
        }

        msg.textContent = 'Kaydedildi'; msg.className='note success';
        setTimeout(async ()=>{
          $('#modal').classList.remove('show');
          // ilgili sekmeyi tazele
          await loadCurrent(true);
        }, 350);
      }catch(err){
        msg.textContent = err.message || 'İşlem başarısız';
        msg.className = 'note error';
      }
    });
  </script>
</body>
</html>
