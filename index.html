<!doctype html>
<html lang="tr" class="light" style="color-scheme: light;">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Üsküdar Sahne Menü</title>

  <!-- Assets / CSS -->
  <link rel="preload" as="image" href="https://qrmenu-cdn.b-cdn.net/assets/header.jpg" fetchpriority="high"/>
  <link rel="preload" as="image" href="https://qrmenu-cdn.b-cdn.net/assets/logo.jpg" fetchpriority="high"/>
  <link data-precedence="next" href="https://qrmenu-cdn.b-cdn.net/css/1.css" rel="stylesheet"/>
  <link data-precedence="next" href="https://qrmenu-cdn.b-cdn.net/css/2.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://qrmenu-cdn.b-cdn.net/css/slider.css">
  <link rel="icon" type="image/x-icon" sizes="32x32" href="/favicon.ico"/>
  <meta name="description" content="Üsküdar Sahne Menü"/>
  <meta property="og:title" content="Üsküdar Sahne Menü"/>
  <link rel="preload" href="https://qrmenu-cdn.b-cdn.net/fonts/e4af272ccee01ff0-s.p.woff2" as="font" type="font/woff2" crossorigin>

  <!-- Küçük yardımcı stiller -->
  <style>
    .is-hidden{ display:none !important; }

    /* Slider */
    .auto-slider{ position:relative; overflow:hidden; user-select:none; }
    .auto-slider .track{
      display:flex; transition: transform .45s ease; will-change: transform;
      touch-action: pan-y; /* dikey kaydırmaya izin ver */
    }
    .auto-slider.dragging .track{ transition:none; cursor:grabbing; }
    .auto-slider .slide{ flex: 0 0 100%; }
    .auto-slider .slide img{ display:block; width:100%; height:400px; object-fit:contain; }

    .auto-slider .nav{
      position:absolute; top:50%; transform:translateY(-50%);
      background:rgba(0,0,0,.45); color:#fff; border:0; width:36px; height:36px;
      border-radius:999px; cursor:pointer; z-index:20;
      display:flex; align-items:center; justify-content:center;
    }
    .auto-slider .nav.prev{ left:8px; }
    .auto-slider .nav.next{ right:8px; }
  </style>
</head>
<body>
  <div class="__className_e8ce0c">
    <div class="min-h-screen md:min-w-[500px] max-w-[500px] mx-auto bg-qrbackground">
      <!-- HEADER -->
      <div class="mx-auto">
        <div class="relative">
          <div class="h-52 w-full">
            <div class="absolute inset-0">
              <img src="https://qrmenu-cdn.b-cdn.net/assets/header.jpg" alt="background" class="w-full h-full object-cover" width="1920" height="1080" decoding="async" fetchpriority="high"/>
              <div class="absolute inset-0"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- FILTER BAR (tasarım korunur) -->
      <div class="mb-3 mt-1 px-3" style="margin-top:1rem">
        <div class="flex items-center justify-between w-full pt-1">
          <div class="flex items-center space-x-2 w-full">
            <div class="flex space-x-2 overflow-x-auto flex-1">
              <button class="filter-btn inline-flex items-center justify-center whitespace-nowrap rounded-md transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 active:text-opacity-50 bg-qrbackground !rounded-sm border border-qrborder2 px-4 py-2 capitalize font-normal text-[12px] h-8 w-[72px]" data-filter="all">Tümü</button>
              <button class="filter-btn inline-flex items-center justify-center whitespace-nowrap rounded-md transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 active:text-opacity-50 bg-qrbackground !rounded-sm border border-qrborder2 px-4 py-2 capitalize font-normal text-[12px] h-8 w-[72px]" data-filter="food">Yemek</button>
              <button class="filter-btn inline-flex items-center justify-center whitespace-nowrap rounded-md transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 active:text-opacity-50 bg-qrbackground !rounded-sm border border-qrborder2 px-4 py-2 capitalize font-normal text-[12px] h-8 w-[72px]" data-filter="drink">İçecek</button>
            </div>
          </div>
        </div>
      </div>

      <!-- CATEGORY GRID (dynamic) -->
      <div class="px-3">
        <div id="menuGrid" class="grid gap-3 grid-cols-2"></div>
      </div>

      <!-- EVENTS SLIDER (manual only, infinite loop) -->
      <section id="eventsSection" class="px-3 mt-10 justify-center items-center is-hidden" aria-labelledby="events-title">
        <h2 id="events-title" class="text-sm font-semibold text-center">Gelecek Etkinlikler</h2>
        <div class="auto-slider" id="eventsSlider" tabindex="0" aria-label="Etkinlik görsel slider">
          <div class="track" id="autoTrack"></div>
          <button class="nav prev" type="button" data-dir="prev" aria-label="Önceki görsel">‹</button>
          <button class="nav next" type="button" data-dir="next" aria-label="Sonraki görsel">›</button>
        </div>
      </section>

      <!-- FOOTER -->
      <footer class="relative">
        <div class="w-full h-48">
          <img src="https://qrmenu-cdn.b-cdn.net/assets/footer_bg.jpg" alt="footer background" class="w-full h-full object-cover" style="padding-left:0.5rem"/>
          <div class="footer-social" aria-label="Sosyal bağlantılar">
            <a href="https://instagram.com/uskudarsahne" target="_blank" rel="noopener" aria-label="Instagram" title="Instagram">
              <img src="https://qrmenu-cdn.b-cdn.net/assets/instagram.png" alt="Instagram"/>
            </a>
            <a href="https://www.facebook.com/people/Üsküdar-Sahne/61571611235950" target="_blank" rel="noopener" aria-label="Facebook" title="Facebook">
              <img src="https://qrmenu-cdn.b-cdn.net/assets/facebook.png" alt="Facebook"/>
            </a>
            <a href="https://www.google.com/maps/place/ÜSKÜDAR+SAHNE/@41.0251341,29.0139226,919m/data=!3m1!1e3!4m6!3m5!1s0x14cab739fbd2417d:0xe334930169f75ef2!8m2!3d41.0251341!4d29.0139226!16s%2Fg%2F11wv9tk232?entry=ttu" target="_blank" rel="noopener" aria-label="Google Maps" title="Google Maps">
              <img src="https://icons.iconarchive.com/icons/dtafalonso/android-lollipop/32/Maps-icon.png" alt="Google Maps" width="30" height="30">
            </a>
          </div>
        </div>
      </footer>
    </div>
  </div>

  <!-- ==== DATA BINDING SCRIPT (API -> UI) ==== -->
  <script>
    const API_BASE = "https://uskudarsahne-api.onrender.com";
    const FALLBACK_IMG = "https://qrmenu-cdn.b-cdn.net/assets/header.jpg";

    // Türkçe slug
    
    // Türkçe ve genel aksan kaldırma ile güvenli slug
    function slugifyTR(str=''){
      return String(str)
        .normalize('NFD')                       // birleşik harfleri ayrıştır
        .replace(/[u0300-u036f]/g,'')         // aksan işaretlerini at
        // Türkçe özel harf dönüşümleri
        .replace(/ğ/g,'g').replace(/Ğ/g,'G')
        .replace(/ü/g,'u').replace(/Ü/g,'U')
        .replace(/ş/g,'s').replace(/Ş/g,'S')
        .replace(/ı/g,'i').replace(/İ/g,'I')
        .replace(/ö/g,'o').replace(/Ö/g,'O')
        .replace(/ç/g,'c').replace(/Ç/g,'C')
        .toLowerCase()
        .replace(/[^a-z0-9s-]/g,'')            // ascii dışı temizle
        .trim().replace(/s+/g,'-')             // boşlukları tire yap
        .replace(/-+/g,'-');                    // fazla tireleri tekle
    };

      return String(str).split('').map(ch => map[ch] || ch)
        .join('').toLowerCase()
        .replace(/[^a-z0-9s-]/g,'')
        .trim().replace(/s+/g,'-').replace(/-+/g,'-');
    
    const escAttr = s => String(s).replace(/"/g,'&quot;');

    async function fetchJSON(url){
      try{
        const res = await fetch(url, { credentials: 'omit', cache: 'no-store' });
        if(!res.ok) throw new Error(`${res.status}`);
        return await res.json();
      }catch(e){
        console.error("[API ERROR]", url, e);
        return null;
      }
    }

    // ---- KATEGORİLER ----
    function renderCategories(cats){
      const grid = document.getElementById('menuGrid');
      grid.innerHTML = '';
      if(!Array.isArray(cats) || cats.length===0){
        grid.innerHTML = `<div class="col-span-2 text-center text-xs opacity-70 py-6">Kategori bulunamadı.</div>`;
        return;
      }
      for(const c of cats){
        const kind = c.kind || c.type || 'food';
        const name = c.name || '';
        const id   = c._id || '';
        const img  = (c.images && (c.images.w640 || c.images.w1024)) || c.imageUrl || FALLBACK_IMG;
        const slug = slugifyTR(name);

        const a = document.createElement('a');
        a.className = 'block filter-card';
        a.dataset.cat = kind; // menü filtresi için
        a.href = `menu.html?category=${encodeURIComponent(slug)}&categoryId=${encodeURIComponent(id)}`;
        a.innerHTML = `
          <div class="overflow-hidden rounded-sm">
            <div class="w-full aspect-[16/8]">
              <img src="${img}" alt="${escAttr(name)}" class="w-full h-full object-cover" loading="lazy" decoding="async">
            </div>
            <div class="p-1.5 bg-black/10 dark:bg-black/30">
              <h2 class="text-[11px] leading-tight tracking-tight text-center dark:font-light line-clamp-1 font-normal">
                ${name}
              </h2>
            </div>
          </div>`;
        grid.appendChild(a);
      }
    }

    function wireCategoryFilter(){
      const buttons = document.querySelectorAll('.filter-btn');
      buttons.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const f = btn.dataset.filter;
          buttons.forEach(b=>b.classList.remove('ring','ring-1'));
          btn.classList.add('ring','ring-1');

          document.querySelectorAll('.filter-card').forEach(card=>{
            const ok = (f==='all') || (card.dataset.cat === f);
            card.style.display = ok ? '' : 'none';
          });
        });
      });
    }

    async function loadCategories(){
      const data = await fetchJSON(`${API_BASE}/api/categories`);
      if(data) { renderCategories(data); wireCategoryFilter(); }
    }

    // ---- ETKİNLİKLER (slider) ----
    function destroySliderDrag(){
      const container = document.getElementById('eventsSlider');
      if(!container) return;
      container.onpointerdown = container.onpointermove = container.onpointerup = null;
      container.ontouchstart = container.ontouchmove = container.ontouchend = null;
    }

    function initManualSlider(){
      destroySliderDrag();
      const container = document.getElementById('eventsSlider');
      const track = document.getElementById('autoTrack');
      const prevBtn = container.querySelector('.nav.prev');
      const nextBtn = container.querySelector('.nav.next');

      const slides = track.children.length;
      if(!slides) return;

      // 1 slayt varsa butonları gizle
      if (slides < 2){
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'none';
      } else {
        prevBtn.style.display = '';
        nextBtn.style.display = '';
      }

      let index = 0;
      const go = (i)=>{
        index = (i % slides + slides) % slides; // sonsuz döngü
        track.style.transform = `translateX(${-index * 100}%)`;
      };

      // --- BUTONLAR ---
      prevBtn.onclick = (e)=>{ e.preventDefault(); e.stopPropagation(); go(index - 1); };
      nextBtn.onclick = (e)=>{ e.preventDefault(); e.stopPropagation(); go(index + 1); };

      // --- KLAVYE ---
      container.addEventListener('keydown', (e)=>{
        if(e.key === 'ArrowLeft'){ go(index - 1); }
        if(e.key === 'ArrowRight'){ go(index + 1); }
      });

      // --- SÜRÜKLEME / SWIPE (manual only) ---
      let isDown = false, startX = 0, deltaX = 0;

      const getX = (ev) => ('touches' in ev) ? ev.touches[0].clientX : ev.clientX;
      const thresholdPx = ()=> Math.max(40, container.clientWidth * 0.18);

      const onDown = (ev)=>{
        if (ev.target.closest('.nav')) return; // nav'a tıklama sürükleme başlatmasın
        isDown = true; startX = getX(ev); deltaX = 0;
        container.classList.add('dragging');
        if (ev.pointerId && container.setPointerCapture) {
          try { container.setPointerCapture(ev.pointerId); } catch {}
        }
      };
      const onMove = (ev)=>{
        if(!isDown) return;
        deltaX = getX(ev) - startX;
        const pct = (deltaX / container.clientWidth) * 100;
        track.style.transform = `translateX(${(-index * 100) + pct}%)`;
      };
      const onUp = ()=>{
        if(!isDown) return;
        container.classList.remove('dragging');
        const th = thresholdPx();
        if (Math.abs(deltaX) > th) {
          go(index + (deltaX < 0 ? 1 : -1));
        } else {
          go(index);
        }
        isDown = false; deltaX = 0;
      };

      container.addEventListener('pointerdown', onDown);
      container.addEventListener('pointermove', onMove);
      container.addEventListener('pointerup', onUp);
      container.addEventListener('pointercancel', onUp);
      container.addEventListener('pointerleave', onUp);

      // iOS emniyet
      container.addEventListener('touchstart', onDown, {passive:true});
      container.addEventListener('touchmove', onMove, {passive:true});
      container.addEventListener('touchend', onUp);

      // İlk konum
      go(0);
    }

    function renderEventsSlider(events){
      const section = document.getElementById('eventsSection');
      const track = document.getElementById('autoTrack');

      if(!Array.isArray(events) || events.length === 0){
        section.classList.add('is-hidden');
        track.innerHTML = '';
        return;
      }

      section.classList.remove('is-hidden');
      track.innerHTML = '';

      for(const ev of events){
        const name = ev.name || 'Etkinlik';
        const when = ev.eventDate ? new Date(ev.eventDate) : null;
        const alt = when ? `${name} – ${when.toLocaleString('tr-TR')}` : name;
        const img = (ev.images && (ev.images.w1024 || ev.images.w640)) || ev.imageUrl || FALLBACK_IMG;

        const slide = document.createElement('div');
        slide.className = 'slide';
        slide.innerHTML = `<img src="${img}" alt="${escAttr(alt)}" loading="lazy" decoding="async">`;
        track.appendChild(slide);
      }

      requestAnimationFrame(()=> initManualSlider());
    }

    function startOfTodayISO(){
      const d = new Date();
      d.setHours(0,0,0,0);
      return d.toISOString();
    }

    async function loadUpcomingEvents(){
      const fromISO = startOfTodayISO();
      const url = `${API_BASE}/api/events/upcoming?from=${encodeURIComponent(fromISO)}&limit=12`;

      try{
        const res = await fetch(url, { credentials:'omit', cache:'no-store' });
        if(!res.ok) throw new Error(res.status);
        const data = await res.json();
        renderEventsSlider(data);
      }catch(e){
        renderEventsSlider([]);
        console.error('[events]', e);
      }
    }

    // Boot
    document.addEventListener('DOMContentLoaded', async ()=>{
      await Promise.all([loadCategories(), loadUpcomingEvents()]);
    });
  </script>
</body>
</html>
