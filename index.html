<!doctype html>
<html lang="tr" class="light" style="color-scheme: light;">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Üsküdar Sahne Menü</title>

  <!-- Assets / CSS -->
  <link rel="preload" as="image" href="https://qrmenu-cdn.b-cdn.net/assets/header.jpg" fetchpriority="high"/>
  <link rel="preload" as="image" href="https://qrmenu-cdn.b-cdn.net/assets/logo.jpg" fetchpriority="high"/>
  <link data-precedence="next" href="https://qrmenu-cdn.b-cdn.net/css/1.css" rel="stylesheet"/>
  <link data-precedence="next" href="https://qrmenu-cdn.b-cdn.net/css/2.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://qrmenu-cdn.b-cdn.net/css/slider.css">
  <link rel="icon" type="image/x-icon" sizes="32x32" href="/favicon.ico"/>
  <meta name="description" content="Üsküdar Sahne Menü"/>
  <meta property="og:title" content="Üsküdar Sahne Menü"/>
  <link rel="preload" href="https://qrmenu-cdn.b-cdn.net/fonts/e4af272ccee01ff0-s.p.woff2" as="font" type="font/woff2" crossorigin>
</head>
<body>
  <div class="__className_e8ce0c">
    <div class="min-h-screen md:min-w-[500px] max-w-[500px] mx-auto bg-qrbackground">
      <!-- HEADER -->
      <div class="mx-auto">
        <div class="relative">
          <div class="h-52 w-full">
            <div class="absolute inset-0">
              <img src="https://qrmenu-cdn.b-cdn.net/assets/header.jpg" alt="background" class="w-full h-full object-cover" width="1920" height="1080" decoding="async" fetchpriority="high"/>
              <div class="absolute inset-0"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- FILTER BAR -->
      <div class="mb-3 mt-1 px-3" style="margin-top:1rem">
        <div class="flex items-center justify-between w-full pt-1">
          <div class="flex items-center space-x-2 w-full">
            <div class="flex space-x-2 overflow-x-auto flex-1">
              <button class="filter-btn inline-flex items-center justify-center whitespace-nowrap rounded-md transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 dark:active:text-opacity-50 active:text-opacity-50 bg-qrbackground !rounded-sm dark:border-transparent border border-qrborder2 dark:bg-[#26282d] px-4 py-2 capitalize font-normal text-[12px] h-8 w-[72px]" data-filter="all">Tümü</button>
              <button class="filter-btn inline-flex items-center justify-center whitespace-nowrap rounded-md transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 dark:active:text-opacity-50 dark:text-white active:text-opacity-50 bg-qrbackground !rounded-sm dark:border-transparent border border-qrborder2 dark:bg-[#26282d] px-4 py-2 capitalize font-normal text-[12px] h-8 w-[72px]" data-filter="food">Yemek</button>
              <button class="filter-btn inline-flex items-center justify-center whitespace-nowrap rounded-md transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 dark:active:text-opacity-50 dark:text-white active:text-opacity-50 bg-qrbackground !rounded-sm dark:border-transparent border border-qrborder2 dark:bg-[#26282d] px-4 py-2 capitalize font-normal text-[12px] h-8 w-[72px]" data-filter="drink">İçecek</button>
            </div>
          </div>
        </div>
      </div>

      <!-- CATEGORY GRID (dynamic) -->
      <div class="px-3">
        <div id="menuGrid" class="grid gap-3 grid-cols-2"></div>
      </div>

      <!-- EVENTS SLIDER (dynamic) -->
      <section class="px-3 my-3" aria-labelledby="events-title">
        <h2 id="events-title" class="slider-title text-sm font-semibold">Gelecek Etkinlikler</h2>

        <div class="auto-slider">
          <div class="track" id="autoTrack">
            <!-- Boş bırakıyoruz; JS "upcoming" endpoint'ten dolduracak.
                 Eğer API'den sonuç gelmezse bu default statik içerik yedek olarak kalabilir -->
            <div class="slide"><img src="https://qrmenu-cdn.b-cdn.net/assets/1.jpg" alt="Etkinlik 1"></div>
            <div class="slide"><img src="https://qrmenu-cdn.b-cdn.net/assets/2.jpg" alt="Etkinlik 2"></div>
            <div class="slide"><img src="https://qrmenu-cdn.b-cdn.net/assets/3.jpg" alt="Etkinlik 3"></div>
            <div class="slide"><img src="https://qrmenu-cdn.b-cdn.net/assets/4.jpg" alt="Etkinlik 4"></div>
            <div class="slide"><img src="https://qrmenu-cdn.b-cdn.net/assets/5.png" alt="Etkinlik 5"></div>
          </div>

          <button class="nav prev" type="button" data-dir="prev" aria-label="Önceki görsel">‹</button>
          <button class="nav next" type="button" data-dir="next" aria-label="Sonraki görsel">›</button>
        </div>
      </section>

      <!-- FOOTER -->
      <footer class="relative">
        <div class="w-full h-48">
          <img src="https://qrmenu-cdn.b-cdn.net/assets/footer_bg.jpg" alt="footer background" class="w-full h-full object-cover" style="padding-left:0.5rem"/>
          <div class="footer-social" aria-label="Sosyal bağlantılar">
            <a href="https://instagram.com/uskudarsahne" target="_blank" rel="noopener" aria-label="Instagram" title="Instagram">
              <img src="https://qrmenu-cdn.b-cdn.net/assets/instagram.png" alt="Instagram"/>
            </a>
            <a href="https://www.facebook.com/people/Üsküdar-Sahne/61571611235950" target="_blank" rel="noopener" aria-label="Facebook" title="Facebook">
              <img src="https://qrmenu-cdn.b-cdn.net/assets/facebook.png" alt="Facebook"/>
            </a>
            <a href="https://www.google.com/maps/place/ÜSKÜDAR+SAHNE/@41.0251341,29.0139226,919m/data=!3m1!1e3!4m6!3m5!1s0x14cab739fbd2417d:0xe334930169f75ef2!8m2!3d41.0251341!4d29.0139226!16s%2Fg%2F11wv9tk232?entry=ttu" target="_blank" rel="noopener" aria-label="Google Maps" title="Google Maps">
              <img src="https://icons.iconarchive.com/icons/dtafalonso/android-lollipop/32/Maps-icon.png" alt="Google Maps" width="30" height="30">
            </a>
          </div>
        </div>
      </footer>
    </div>
  </div>

  <!-- ==== DATA BINDING SCRIPT (API -> UI) ==== -->
  <script>
    const API_BASE = "https://uskudarsahne-api.onrender.com";
    const FALLBACK_IMG = "https://qrmenu-cdn.b-cdn.net/assets/header.jpg";

    // Türkçe slug
    function slugifyTR(str=''){
      const map = { 'Ç':'C','Ö':'O','Ş':'S','İ':'I','I':'I','Ü':'U','Ğ':'G',
                    'ç':'c','ö':'o','ş':'s','ı':'i','i':'i','ü':'u','ğ':'g' };
      return String(str).split('').map(ch => map[ch] || ch)
        .join('').toLowerCase()
        .replace(/[^a-z0-9\s-]/g,'')
        .trim().replace(/\s+/g,'-').replace(/-+/g,'-');
    }
    const escAttr = s => String(s).replace(/"/g,'&quot;');

    async function fetchJSON(url){
      try{
        const res = await fetch(url, { credentials: 'omit' });
        if(!res.ok) throw new Error(`${res.status}`);
        return await res.json();
      }catch(e){
        console.error("[API ERROR]", url, e);
        return null;
      }
    }

    function renderCategories(cats){
      const grid = document.getElementById('menuGrid');
      grid.innerHTML = '';
      if(!Array.isArray(cats) || cats.length===0){
        grid.innerHTML = `<div class="col-span-2 text-center text-xs opacity-70 py-6">Kategori bulunamadı.</div>`;
        return;
      }
      for(const c of cats){
        const kind = c.kind || c.type || 'food';
        const name = c.name || '';
        const id   = c._id || '';
        const img  = (c.images && (c.images.w640 || c.images.w1024)) || c.imageUrl || FALLBACK_IMG;
        const slug = slugifyTR(name);

        const a = document.createElement('a');
        a.className = 'block filter-card';
        a.dataset.cat = kind; // menü filtresi için
        a.href = `menu.html?category=${encodeURIComponent(slug)}&categoryId=${encodeURIComponent(id)}`;
        a.innerHTML = `
          <div class="overflow-hidden rounded-sm">
            <div class="w-full aspect-[16/8]">
              <img src="${img}" alt="${escAttr(name)}" class="w-full h-full object-cover" loading="lazy" decoding="async">
            </div>
            <div class="p-1.5 bg-black/10 dark:bg-black/30">
              <h2 class="text-[11px] leading-tight tracking-tight text-center dark:font-light line-clamp-1 font-normal">
                ${name}
              </h2>
            </div>
          </div>`;
        grid.appendChild(a);
      }
    }

    function wireCategoryFilter(){
      const buttons = document.querySelectorAll('.filter-btn');
      buttons.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const f = btn.dataset.filter;
          buttons.forEach(b=>b.classList.remove('ring','ring-1')); // basit aktif görseli istersen class ekle
          btn.classList.add('ring','ring-1');

          document.querySelectorAll('.filter-card').forEach(card=>{
            const ok = (f==='all') || (card.dataset.cat === f);
            card.style.display = ok ? '' : 'none';
          });
        });
      });
    }

    async function loadCategories(){
      const data = await fetchJSON(`${API_BASE}/api/categories`);
      if(data) { renderCategories(data); wireCategoryFilter(); }
    }

    function startOfTodayISO(){
      const d = new Date();
      d.setHours(0,0,0,0);
      return d.toISOString();
    }

    function renderEventsSlider(events){
      if(!Array.isArray(events) || events.length===0) return; // mevcut statik içerik kalsın
      const track = document.getElementById('autoTrack');
      track.innerHTML = '';
      for(const ev of events){
        const name = ev.name || 'Etkinlik';
        const when = ev.eventDate ? new Date(ev.eventDate) : null;
        const alt = when ? `${name} – ${when.toLocaleString('tr-TR')}` : name;
        const img = (ev.images && (ev.images.w1024 || ev.images.w640)) || ev.imageUrl || FALLBACK_IMG;

        const slide = document.createElement('div');
        slide.className = 'slide';
        slide.innerHTML = `<img src="${img}" alt="${escAttr(alt)}">`;
        track.appendChild(slide);
      }
    }

    async function loadUpcomingEvents(){
      const fromISO = startOfTodayISO();
      const url = `${API_BASE}/api/events/upcoming?from=${encodeURIComponent(fromISO)}&limit=12`;
      const data = await fetchJSON(url);
      if(data) renderEventsSlider(data);
    }

    // Boot
    document.addEventListener('DOMContentLoaded', async ()=>{
      await Promise.all([loadCategories(), loadUpcomingEvents()]);
      // menufilter.js/slider.js zaten en altta yüklenecek; DOM hazır olduğunda çalışacak.
    });
  </script>

  <!-- Bu sıralama önemli: önce dinamik içerik oluşturuldu, ardından slider ve filtre betikleri devreye giriyor -->
  <script src="./scripts/slider.js"></script>
  <script src="./scripts/menufilter.js"></script>
</body>
</html>
