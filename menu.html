<!doctype html>
<html lang="tr" class="light" style="color-scheme: light;">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Üsküdar Sahne Menü</title>

  <!-- CSS / Assets -->
  <link rel="stylesheet" href="https://qrmenu-cdn.b-cdn.net/css/1.css" data-precedence="next" />
  <link rel="stylesheet" href="https://qrmenu-cdn.b-cdn.net/css/2.css" data-precedence="next" />
  <link rel="preload" href="https://qrmenu-cdn.b-cdn.net/fonts/e4af272ccee01ff0-s.p.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="32x32" />
  <meta name="description" content="Üsküdar Sahne Menü" />
  <meta name="next-size-adjust"/>

  <style>
    :root{
      --qrblue: #2563eb;
    }
    /* Üst şerit yatay scroll alanı */
    .scroll-area [data-radix-scroll-area-viewport] {
      scrollbar-width: none;
      -ms-overflow-style: none;
      -webkit-overflow-scrolling: touch;
    }
    .scroll-area [data-radix-scroll-area-viewport]::-webkit-scrollbar { display: none; }
    .scroll-area :where([data-radix-scroll-area-viewport]) { display: flex; flex-direction: column; align-items: stretch; }
    .scroll-area :where([data-radix-scroll-area-content]) { flex-grow: 1; }
    /* Bölüm başlıkları scroll hedefi olduğunda üstte biraz pay bıraksın */
    .cat-section { scroll-margin-top: 12px; }
    /* Aktif/pasif kategori sekmesi */
    .cat-tab { transition: color .2s ease; }
    .cat-tab[data-active="true"] { color: var(--qrblue, #2563eb); font-weight: 600; }
    .cat-tab[data-active="false"] { color: #000; font-weight: 300; }

    
    /* ====== Sticky Kategori Bar (two-state, no animation) ====== */
    .catbar {
      position: sticky; top: 0; z-index: 1000;
      background: rgba(255,255,255,0.95);
      -webkit-backdrop-filter: blur(8px);
      backdrop-filter: blur(8px);
      /* no transitions to avoid in-between states */
    }
    .catbar .thumbWrap { display: block; }
    .catbar.compact .thumbWrap { display: none; } /* hide images completely */
    .catbar .tabText { padding: 6px 8px; }
    .catbar.compact .tabText { padding: 8px 10px; }
    .catbar.compact .cat-tab { font-size: 12px; }
    /* item width: normal 109px, compact fits text */
    #categoryBar > div { width: 109px; }
    .catbar.compact #categoryBar > div { width: auto !important; }

    .catbar {
      position: sticky; top: 0; z-index: 1000;
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      transition: padding .2s ease, box-shadow .2s ease, background .2s ease;
      padding: 4px 0;
    }
    .catbar.compact { box-shadow: 0 2px 10px rgba(0,0,0,.06); padding: 2px 0; min-height: 38px; }
    .catbar .thumbWrap { height: 84px; overflow: hidden; transition: height .22s ease, padding .22s ease; }
    .catbar.compact .thumbWrap { height: 0; padding-top: 0; }
    .catbar .tabText { padding: 6px 8px; transition: padding .2s ease, background .2s ease; }
    .catbar.compact .tabText { padding: 6px 10px; background: transparent; }
    .catbar.compact .cat-tab { font-size: 12px; }

    /* Her item genişliği: normalde 109px, compact'ta metne göre (auto) */
    #categoryBar > div { width: 109px; }
    .catbar.compact #categoryBar > div { width: auto !important; }


    /* ====== Lazy image (placeholder) ====== */
    .lazy-img {
      background: #eee;
      filter: blur(6px);
      transform: scale(1.02);
      transition: filter .3s ease, transform .3s ease, opacity .3s ease;
    }
    .lazy-img.loaded {
      filter: blur(0);
      transform: none;
    }

    /* ====== Back To Top Button ====== */
    .backTopBtn{
      position: fixed; inset: auto 16px 16px auto;
      display: none; align-items: center; justify-content: center;
      width: 44px; height: 44px; border-radius: 999px;
      background: #111827; color: #fff; font-size: 18px; line-height: 1;
      box-shadow: 0 8px 22px rgba(0,0,0,.25);
      z-index: 9999; border: 1px solid rgba(255,255,255,.12);
    }
    .backTopBtn.show{ display:flex; }
    .backTopBtn:active{ transform: scale(0.98); }

    @media (min-width: 640px){
      .backTopBtn{ width: 50px; height: 50px; font-size: 20px; }
    }
  </style>
</head>
<body>
  <div class="__className_e8ce0c">
    <div class="min-h-screen w-full max-w-[500px] md:justify-self-center bg-qrbackground pb-7 mx-auto">

      <!-- ÜST YATAY KATEGORİ ŞERİDİ (dinamik, sticky/compact) -->
      <div id="catArea" class="catbar">
        <div class="container mx-auto mb-3 px-3">
          <div dir="ltr" class="relative w-full whitespace-nowrap mb-0 overflow-hidden scroll-area"
               style="position: relative; --radix-scroll-area-corner-width: 0px; --radix-scroll-area-corner-height: 0px;">
            <div data-radix-scroll-area-viewport class="h-fit w-full rounded-[inherit]" style="overflow: scroll;">
              <div data-radix-scroll-area-content style="min-width: fit-content;">
                <div id="categoryBar" class="flex w-max space-x-1 p-0 pt-1"><!-- JS dolduracak --></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TÜM KATEGORİ+ÜRÜNLER (dinamik) -->
      <div class="menu-items px-3" id="menuRoot"><!-- JS dolduracak --></div>
   
    </div>
  </div>

  <!-- Back To Top Button -->
  <button id="btnTop" class="backTopBtn" aria-label="En üste dön" title="En üste dön">↑</button>

  <!-- ==== DATA BINDING (API -> UI) ==== -->
  <script>
    const API_BASE = "https://uskudarsahne-api.onrender.com";
    const PLACEHOLDER_SRC = "https://qrmenu-cdn.b-cdn.net/assets/logo.jpg";
    const FALLBACK_IMG = PLACEHOLDER_SRC; // Yükleme hatasında da bunu kullan

    // Tek seferlik placeholder fetch → blob:URL
    let PLACEHOLDER_URL = PLACEHOLDER_SRC;
    const placeholderReady = (async ()=>{
      try{
        const res = await fetch(PLACEHOLDER_SRC, { mode:'cors', credentials:'omit', cache:'force-cache' });
        const blob = await res.blob();
        PLACEHOLDER_URL = URL.createObjectURL(blob);
      }catch(e){
        PLACEHOLDER_URL = PLACEHOLDER_SRC;
      }
      return PLACEHOLDER_URL;
    })();

    // Türkçe slug
    function slugifyTR(str=''){
      const map = { 'Ç':'C','Ö':'O','Ş':'S','İ':'I','I':'I','Ü':'U','Ğ':'G','ç':'c','ö':'o','ş':'s','ı':'i','i':'i','ü':'u','ğ':'g' };
      return String(str).split('').map(ch => map[ch] || ch)
        .join('').toLowerCase().replace(/[^a-z0-9\s-]/g,'')
        .trim().replace(/\s+/g,'-').replace(/-+/g,'-');
    }
    const escAttr = s => String(s).replace(/"/g,'&quot;');

    async function fetchJSON(url){
      try{
        const res = await fetch(url, { credentials: 'omit' });
        if(!res.ok) throw new Error(`${res.status}`);
        return await res.json();
      }catch(e){
        console.error("[API ERROR]", url, e);
        return null;
      }
    }

    function priceToNumber(p){
      if (p == null) return null;
      if (typeof p === 'number') return p;
      if (typeof p === 'string') return parseFloat(p.replace(',', '.'));
      if (typeof p === 'object' && p.$numberDecimal) return parseFloat(p.$numberDecimal);
      try { return parseFloat(p); } catch { return null; }
    }
    function formatTRY(p){
      const n = priceToNumber(p);
      if (isNaN(n) || n == null) return '';
      return n.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY', minimumFractionDigits: 2 });
    }

    /* ===== Lazy Loader ===== */
    function setupLazyImages(root=document){
      const imgs = Array.from(root.querySelectorAll('img.lazy-img'));
      if (!imgs.length) return;

      const onIntersect = (entries, obs)=>{
        entries.forEach(entry=>{
          if(!entry.isIntersecting) return;
          const img = entry.target;
          const real = img.dataset.src;
          if(real){
            img.onload = ()=> img.classList.add('loaded');
            img.onerror = ()=> { img.src = PLACEHOLDER_URL; img.classList.add('loaded'); };
            img.src = real;
            img.removeAttribute('data-src');
          }
          obs.unobserve(img);
        });
      };
      const io = new IntersectionObserver(onIntersect, { root: null, rootMargin: '200px 0px', threshold: 0.01 });
      imgs.forEach(img => io.observe(img));
    }

    // --- UI Renderers ---
    function renderCategoryTabs(categories){
      const bar = document.getElementById('categoryBar');
      bar.innerHTML = '';
      for(const c of categories){
        const slug = slugifyTR(c.name||'');
        const real = (c.images && (c.images.w640 || c.images.w1024)) || FALLBACK_IMG;
        const el = document.createElement('div');
        el.className = 'w-[109px] border-hidden cursor-pointer';
        el.setAttribute('role','link');
        el.dataset.slug = slug;
        el.innerHTML = `
          <div class="thumbWrap h-[84px] pt-1 line-clamp-1">
            <img alt="${escAttr(c.name)}" loading="lazy" width="1920" height="1080" decoding="async"
                 class="w-full h-full object-cover rounded-t-sm lazy-img"
                 src="${PLACEHOLDER_URL}" data-src="${real}" style="color: transparent;"/>
          </div>
          <div class="tabText p-1.5 bg-black/10 bg-black/30 rounded-b-sm">
            <h3 class="text-[11px] leading-tight tracking-tight text-center line-clamp-1">
              <span class="cat-tab" data-active="false">${c.name||''}</span>
            </h3>
          </div>`;
        el.addEventListener('click', ()=> scrollToCategory(slug));
        bar.appendChild(el);
      }
      setupLazyImages(bar);
    }

    function productCardHTML(p){
      const real = (p.images && (p.images.w640 || p.images.w1024)) || FALLBACK_IMG;
      const name = p.name || '';
      const desc = p.description || '';
      const priceText = formatTRY(p.price);
      return `
      <div class="">
        <div class="relative">
          <div class="bg-qrborder/0 border-none rounded-sm cursor-pointer">
            <div class="p-0 flex">
              <div class="w-[50%] aspect-[4/3] flex-shrink-0 relative">
                <img alt="${escAttr(name)}" loading="lazy" width="1600" height="1200" decoding="async"
                     class="w-full h-full object-cover rounded-sm lazy-img"
                     src="${PLACEHOLDER_URL}" data-src="${real}" style="color: transparent;"/>
                <div class="absolute top-1.5 right-1.5 flex flex-row gap-1.5"></div>
              </div>
              <div class="w-[50%] flex flex-col justify-between py-1.5 pl-2.5">
                <div>
                  <div class="flex items-start space-x-2">
                    <h3 class="text-sm font-normal line-clamp-1">${name}</h3>
                  </div>
                  <p class="text-[11px] mt-1 text-gray-700 line-clamp-4 font-light">${escAttr(desc)}</p>
                </div>
                <div class="flex items-center space-x-2">
                  <span class="font-light text-[13px] whitespace-nowrap"><span>${priceText}</span></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>`;
    }

    function categorySectionHTML(cat){
      const slug = slugifyTR(cat.name||'');
      return `
      <section id="category-${slug}" class="cat-section">
        <div class="flex flex-col items-center mb-3 mt-3">
          <div class="bg-qrborder2 p-2 rounded-sm flex w-full items-center justify-center">
            <p class="text-[14px] font-light tracking-wider text-center overflow-hidden text-ellipsis">
              ${cat.name||''}
            </p>
          </div>
        </div>
        <div class="grid gap-2.5 grid-cols-1" id="grid-${slug}">
          <!-- ürünler gelecek -->
        </div>
      </section>`;
    }

    function renderAllSections(categories){
      const root = document.getElementById('menuRoot');
      root.innerHTML = '';
      for (const c of categories) {
        root.insertAdjacentHTML('beforeend', categorySectionHTML(c));
      }
    }

    async function fillProductsFor(categories){
      await Promise.all(categories.map(async c=>{
        const slug = slugifyTR(c.name||'');
        const grid = document.getElementById(`grid-${slug}`);
        const list = await fetchJSON(`${API_BASE}/api/products?categoryId=${encodeURIComponent(c._id)}&limit=500`);
        if (!Array.isArray(list) || list.length===0){
          grid.innerHTML = `<div class="text-center text-xs opacity-70 py-4">Bu kategoride ürün yok.</div>`;
          return;
        }
        // Backend zaten order'a göre sıralı döndürüyor → ek bir sıralama YOK
        grid.innerHTML = list.map(productCardHTML).join('');
        setupLazyImages(grid);
      }));
    }

    // --- Scroll & Active Tab ---
    function scrollToCategory(slug){
      const sec = document.getElementById(`category-${slug}`);
      if (!sec) return;
      sec.scrollIntoView({ behavior: 'smooth', block: 'start' });
      const tab = [...document.querySelectorAll('#categoryBar > div')].find(d => d.dataset.slug === slug);
      if (tab) tab.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
      const params = new URLSearchParams(location.search);
      params.set('category', slug);
      history.replaceState(null, '', `${location.pathname}?${params.toString()}`);
    }

    function setActiveSlug(slug){
      document.querySelectorAll('.cat-tab').forEach(el => el.setAttribute('data-active','false'));
      const active = document.querySelector(`#categoryBar > div[data-slug="${slug}"] .cat-tab`);
      if (active) active.setAttribute('data-active','true');
    }

    function attachActiveObserver(categories){
      const mapSlugToEl = new Map();
      categories.forEach(c=>{
        const slug = slugifyTR(c.name||'');
        const sec = document.getElementById(`category-${slug}`);
        if (sec) mapSlugToEl.set(slug, sec);
      });

      let current = null;
      const obs = new IntersectionObserver((entries)=>{
        const visible = entries.filter(e=> e.isIntersecting).sort((a,b)=> a.boundingClientRect.top - b.boundingClientRect.top);
        if (visible.length){
          const id = visible[0].target.id;
          const slug = id.replace(/^category-/, '');
          if (slug !== current){
            current = slug;
            setActiveSlug(slug);
          }
        }
      }, { root: null, threshold: 0.5 });

      for (const [,sec] of mapSlugToEl) obs.observe(sec);

      const initial = new URLSearchParams(location.search).get('category');
      if (initial && mapSlugToEl.has(initial)) {
        setActiveSlug(initial);
        setTimeout(()=> scrollToCategory(initial), 50);
      } else {
        const first = categories.length ? slugifyTR(categories[0].name||'') : null;
        if (first) setActiveSlug(first);
      }
    }

    // Sticky bar compact + Back to top visibility
    function handleScrollUI(){
      const y = window.scrollY || document.documentElement.scrollTop || 0;
      const catArea = document.getElementById('catArea');
      const btnTop = document.getElementById('btnTop');
      const compactOn = y > 0; // strictly: top vs not-top
      catArea.classList.toggle('compact', compactOn);
      btnTop.classList.toggle('show', y > 250);
    }

    // ---- BOOT ----
    document.addEventListener('DOMContentLoaded', async ()=>{
      // Placeholder'ı tek seferlik hazırlarken kategorileri ve ürünleri getir
      await placeholderReady;

      const categories = await fetchJSON(`${API_BASE}/api/categories`);
      if (!Array.isArray(categories) || categories.length===0){
        document.getElementById('menuRoot').innerHTML =
          `<div class="text-center text-xs opacity-70 py-6">Kategori bulunamadı.</div>`;
        return;
      }
      renderCategoryTabs(categories);
      renderAllSections(categories);
      await fillProductsFor(categories);
      attachActiveObserver(categories);

      // Scroll davranışları
      handleScrollUI();
      window.addEventListener('scroll', handleScrollUI, { passive: true });

      // Back to top
      document.getElementById('btnTop').addEventListener('click', ()=> {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    });
  </script>
</body>
</html>
