<!doctype html>
<html lang="tr" class="light" style="color-scheme: light;">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Üsküdar Sahne Menü</title>
  <meta name="description" content="Üsküdar Sahne Menü"/>
  <link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="32x32"/>

  <!-- mevcut stil dosyaların -->
  <link rel="stylesheet" href="https://qrmenu-cdn.b-cdn.net/css/1.css" data-precedence="next"/>
  <link rel="stylesheet" href="https://qrmenu-cdn.b-cdn.net/css/2.css" data-precedence="next"/>
  <link rel="preload" href="https://qrmenu-cdn.b-cdn.net/fonts/e4af272ccee01ff0-s.p.woff2" as="font" crossorigin type="font/woff2"/>

  <!-- ufak yardımcı stiller -->
  <style>
    .skeleton{background:linear-gradient(90deg,#eeeeee22, #ffffff11, #eeeeee22) ; background-size: 200% 100%; animation: sk 1.1s infinite;}
    @keyframes sk { 0%{background-position: 200% 0;} 100%{background-position: -200% 0;} }
    .text-ellipsis{overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
  </style>
</head>
<body>
  <div class="__className_e8ce0c">
    <div class="min-h-screen w-full max-w-[500px] md:justify-self-center bg-qrbackground pb-7 mx-auto">

      <!-- KATEGORİ ŞERİDİ -->
      <div class="container mx-auto mb-3 px-3">
        <div dir="ltr" class="relative w-full whitespace-nowrap overflow-hidden scroll-area">
          <div data-radix-scroll-area-viewport class="h-fit w-full rounded-[inherit]" style="overflow:auto">
            <div data-radix-scroll-area-content style="min-width:fit-content">
              <div id="catStrip" class="flex w-max space-x-1 p-0 pt-1">
                <!-- JS dolduracak -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- KATEGORİ BAŞLIK -->
      <div class="flex flex-col items-center mb-3 mt-1 px-3">
        <div class="bg-qrborder2 p-2 rounded-sm flex w-full items-center justify-center">
          <p id="catTitle" class="text-[14px] font-normal font-light tracking-wider text-center overflow-hidden text-ellipsis">Yükleniyor…</p>
        </div>
      </div>

      <!-- ÜRÜN LİSTESİ -->
      <div class="px-3">
        <div id="productGrid" class="grid gap-2.5 grid-cols-1">
          <!-- JS dolduracak -->
        </div>
        <div id="emptyMsg" class="text-center text-xs opacity-70 py-6 hidden">Bu kategoride ürün yok.</div>
      </div>

      <!-- ALT BAR (logon varsa) -->
      <div class="md:min-w-[500px] max-w-[500px] fixed flex justify-center -bottom-1 bg-qrbackground z-[100] w-full h-6">
        <button class="inline-flex items-center justify-center h-9 px-4 py-2 pb-6 text-black bg-none"></button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "https://uskudarsahne-api.onrender.com";
    const FALLBACK_IMG = "https://qrmenu-cdn.b-cdn.net/assets/header.jpg";

    // --- utils ---
    function $(s,root=document){ return root.querySelector(s); }
    function escAttr(s){ return String(s ?? '').replace(/"/g,'&quot;'); }
    function fmtTRY(n){ return new Intl.NumberFormat('tr-TR',{style:'currency',currency:'TRY'}).format(Number(n)||0); }
    function decToNumber(v){
      if (v == null) return 0;
      if (typeof v === 'object' && v.$numberDecimal) return parseFloat(v.$numberDecimal);
      if (typeof v === 'string') return parseFloat(v);
      return Number(v);
    }
    const slugifyTR = s => String(s||'')
      .replaceAll('Ç','C').replaceAll('Ö','O').replaceAll('Ş','S').replaceAll('İ','I').replaceAll('I','I').replaceAll('Ü','U').replaceAll('Ğ','G')
      .replaceAll('ç','c').replaceAll('ö','o').replaceAll('ş','s').replaceAll('ı','i').replaceAll('i','i').replaceAll('ü','u').replaceAll('ğ','g')
      .toLowerCase().replace(/[^a-z0-9\s-]/g,'').trim().replace(/\s+/g,'-').replace(/-+/g,'-');

    function getQuery(){
      const p = new URLSearchParams(location.search);
      return { categoryId: p.get('categoryId') || '', categorySlug: p.get('category') || '' };
    }

    async function fetchJSON(url){
      try{
        const res = await fetch(url, { credentials:'omit' });
        if(!res.ok) throw new Error(res.status);
        return await res.json();
      }catch(e){
        console.error('API error:', url, e);
        return null;
      }
    }

    // --- UI builders ---
    function catChip(c){
      const name = c.name || '';
      const img  = (c.images && (c.images.w640 || c.images.w1024)) || FALLBACK_IMG;
      const slug = slugifyTR(name);
      const id   = c._id || '';

      const wrap = document.createElement('a');
      wrap.className = "w-[109px] border-hidden cursor-pointer";
      wrap.href = `menu.html?category=${encodeURIComponent(slug)}&categoryId=${encodeURIComponent(id)}`;
      wrap.innerHTML = `
        <div class="h-[84px] pt-1">
          <img alt="${escAttr(name)}" loading="lazy" width="1920" height="1080" decoding="async"
               class="w-full h-full object-cover rounded-t-sm"
               src="${img}" style="color:transparent;">
        </div>
        <div class="p-1.5 bg-black/10 bg-black/30 rounded-b-sm">
          <h3 class="text-[11px] leading-tight tracking-tight text-center font-normal line-clamp-1 text-qrblue">
            <p class="line-clamp-1">${name}</p>
          </h3>
        </div>`;
      return wrap;
    }

    function productCard(p){
      const name = p.name || '';
      const desc = p.description || '';
      const price = fmtTRY(decToNumber(p.price));
      const img  = (p.images && (p.images.w1024 || p.images.w640)) || p.imageUrl || FALLBACK_IMG;

      const node = document.createElement('div');
      node.innerHTML = `
        <div class="relative">
          <div class="cursor-pointer">
            <div class="bg-qrborder/0 border-none rounded-sm">
              <div class="p-0 flex">
                <div class="w-[50%] aspect-[4/3] flex-shrink-0 relative">
                  <img alt="${escAttr(name)}" loading="lazy" width="1920" height="1080" decoding="async"
                       class="w-full h-full object-cover rounded-sm" src="${img}" style="color:transparent;">
                  <div class="absolute top-1.5 right-1.5 flex flex-row gap-1.5"></div>
                </div>
                <div class="w-[50%] flex flex-col justify-between py-1.5 pl-2.5">
                  <div>
                    <div class="flex items-start space-x-2">
                      <h3 class="text-sm font-normal line-clamp-1">${name}</h3>
                    </div>
                    <p class="text-[11px] mt-1 text-gray-400 text-gray-700 line-clamp-4 font-normal font-light">${desc}</p>
                  </div>
                  <div class="flex items-center space-x-2">
                    <span class="font-normal font-light text-[13px] whitespace-nowrap"><span>${price}</span></span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>`;
      return node.firstElementChild;
    }

    function renderSkeletonProducts(count=4){
      const grid = $('#productGrid'); grid.innerHTML = '';
      for(let i=0;i<count;i++){
        const sk = document.createElement('div');
        sk.innerHTML = `
          <div class="p-0 flex">
            <div class="w-[50%] aspect-[4/3] rounded-sm skeleton"></div>
            <div class="w-[50%] py-1.5 pl-2.5">
              <div class="h-4 w-3/4 rounded-sm skeleton mb-2"></div>
              <div class="h-3 w-full rounded-sm skeleton mb-1"></div>
              <div class="h-3 w-5/6 rounded-sm skeleton mb-1"></div>
              <div class="h-3 w-2/3 rounded-sm skeleton mt-3"></div>
            </div>
          </div>`;
        grid.appendChild(sk);
      }
      $('#emptyMsg').classList.add('hidden');
    }

    // --- data loading ---
    async function loadAndRender(){
      const { categoryId: qId, categorySlug: qSlug } = getQuery();

      // 1) Kategoriler
      const cats = await fetchJSON(`${API_BASE}/api/categories`) || [];
      const catStrip = $('#catStrip'); catStrip.innerHTML = '';
      cats.forEach(c => catStrip.appendChild(catChip(c)));

      // aktif kategori seçimi
      let active = null;
      if(qId) active = cats.find(c => String(c._id) === String(qId));
      if(!active && qSlug) active = cats.find(c => slugifyTR(c.name) === qSlug);
      if(!active) active = cats[0] || null;

      // başlık
      $('#catTitle').textContent = active ? (active.name || 'Kategori') : 'Kategori bulunamadı';

      // 2) Ürünler (aktif kategoriye göre)
      if(!active){ $('#productGrid').innerHTML = ''; $('#emptyMsg').classList.remove('hidden'); return; }

      renderSkeletonProducts(6);
      const prods = await fetchJSON(`${API_BASE}/api/products?categoryId=${encodeURIComponent(active._id)}`) || [];
      const grid = $('#productGrid'); grid.innerHTML = '';

      if(prods.length === 0){
        $('#emptyMsg').classList.remove('hidden');
        return;
      }
      $('#emptyMsg').classList.add('hidden');
      prods.forEach(p => grid.appendChild(productCard(p)));

      // Seçili kategori chip’ini vurgula (isteğe bağlı hafif highlight)
      const cur = Array.from(document.querySelectorAll('#catStrip a')).find(a => a.href.includes(`categoryId=${encodeURIComponent(active._id)}`));
      if(cur) cur.querySelector('h3')?.classList.add('font-semibold','text-qrblue');
    }

    // go
    document.addEventListener('DOMContentLoaded', loadAndRender);
  </script>
</body>
</html>
